<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Skeleton Tracing with Font and Unicode</title>
  <style>
    body {
      font-family: sans-serif;
      background: #000;
      color: #fff;
      text-align: center;
    }
    canvas {
      background: black;
      margin-top: 20px;
    }
    #unicodeList {
      font-family: monospace;
      white-space: pre-wrap;
      word-break: break-all;
      color: white;
      text-align: left;
      margin: 20px auto;
      width: 80%;
    }
    #unicodeList h2 {
      text-align: center;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/opentype.js@latest/dist/opentype.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/skeleton-tracing-js/dist/trace_skeleton.min.js"></script>
</head>
<body>

<h1>Skeleton Tracing with Font and Unicode</h1>
<p>Load an image, select a default font or upload a font, and enter text to see the skeleton tracing.</p>

<button onclick="fromImageUrl('test_images/sample.png')">Load Image</button>

<label for="defaultFonts">Select Default Font:</label>
<select id="defaultFonts"></select>

<label for="fontUpload">Upload Font:</label>
<input type="file" id="fontUpload" accept=".ttf,.otf,.woff">

<label for="textInput">Enter Text:</label>
<input type="text" id="textInput" value="ABCD0123">

<div id="unicodeList">
  <h2>Unicode Character List</h2>
  <div id="unicodeValues"></div>
</div>

<canvas id="skeletonCanvas" width="270" height="150"></canvas>
<div id="skeletonOutput" style="pointer-events:none"></div>

<script>
  // Get references to elements
  var canv = document.getElementById("skeletonCanvas");
  var ctx = canv.getContext('2d');
  var div = document.getElementById("skeletonOutput");
  const textInput = document.getElementById("textInput");
  const unicodeValuesDiv = document.getElementById("unicodeValues");
  const fontSelect = document.getElementById("defaultFonts");

  var DWIDTH = 800;
  let currentFont = null; // Store the loaded opentype font
  let currentFontName = 'Arial';  //Store font name
  let currentFontSize = 160;

  const defaultFonts = [
    { name: "English (Arial)", url: "Arial", cssName: "Arial" }, // Arial is usually a system font, so URL is just a name
    { name: "English (Roboto)", url: "./Roboto[wdth,wght].ttf", cssName: "Roboto" }, // You'll need to host this
    { name: "Hindi (Lohit Devanagari)", url: "./Lohit-Devanagari.ttf", cssName: "Lohit Devanagari" }, // You'll need to host this
    { name: "Arabic (Amiri)", url: "./Amiri-Regular.ttf", cssName: "Amiri" } // You'll need to host this
  ];

  defaultFonts.forEach(font => {
    const option = document.createElement("option");
    option.value = font.url;
    option.textContent = font.name;
    fontSelect.appendChild(option);
  });

  function fromImageUrl(url) {
    var img = new Image();
    img.src = url;
    img.onload = function () {
      canv.width = img.width;
      canv.height = img.height;
      ctx.drawImage(img, 0, 0);
      var s = TraceSkeleton.fromCanvas(canv);
      var v = TraceSkeleton.visualize(s, { scale: DWIDTH / img.width, strokeWidth: 4 });
      div.innerHTML = v;
    };
  }

  async function updateSkeletonFromText() {
    const text = textInput.value;
    if (!text) return;

    canv.width = 270;
    canv.height = 150;
    ctx.fillStyle = "black";
    ctx.fillRect(0, 0, canv.width, canv.height);

    ctx.fillStyle = "white";

    //Use the current font
    ctx.font = `${currentFontSize}px ${currentFontName}`;

    ctx.fillText(text, 20, 120);

    const imdata = ctx.getImageData(0, 0, canv.width, canv.height);
    const data = imdata.data;
    let str = "";

    for (let i = 0; i < data.length; i += 4) {
      str += (data[i] > 128) ? "\1" : "\0";
    }

    const s = TraceSkeleton.fromCharString(str, canv.width, canv.height);
    const v = TraceSkeleton.visualize(s, { scale: DWIDTH / canv.width, strokeWidth: 4, keypoints: true });
    div.innerHTML = v;

    // Update the unicode list
    let unicodeList = ""
    for (let i = 0; i < text.length; i++) {
      unicodeList += ` ${text[i]} - Unicode: ${text[i].charCodeAt(0)} <br>`;
    }
    unicodeValuesDiv.innerHTML = unicodeList;

  }

  // Function to handle font loading (either from URL or File)
  async function loadFont(fontSource, isFile = false) {
    try {
      let font;
      if (isFile) {
        font = await opentype.load(fontSource);
      } else if(fontSource != "Arial") {
        font = await opentype.load(fontSource);  //URL
      }

      if (font) {
          //Font was loaded by URL or file, extract its name to render
          currentFontName = font.names.fontFamily.en;
          console.log("ðŸš€ ~ loadFont ~ currentFontName:", currentFontName)
      } else {
          //Set Arial when its system font or opentype load fails
          currentFontName = "Arial"
      }
      updateSkeletonFromText();
    } catch (err) {
      console.error("Error loading font:", err);
      currentFontName = "Arial"; //Fallback to arial upon loading failure
      updateSkeletonFromText();
    }
  }

  // Handle Default Font selection
  document.getElementById("defaultFonts").addEventListener("change", async function () {
    const selectedFontUrl = this.value;
    await loadFont(selectedFontUrl);
  });


  // Font Upload Handling
  document.getElementById("fontUpload").addEventListener("change", async function (event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = async function (e) {
        const fontData = e.target.result;
        await loadFont(fontData, true); // Load from file data
      };
      reader.readAsArrayBuffer(file);
    }
  });

  // Listen for text input changes
  textInput.addEventListener("input", updateSkeletonFromText);

  //Initialize load font with first default font
  loadFont(defaultFonts[0].url)

</script>

</body>
</html>