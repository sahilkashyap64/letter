<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Font Skeleton Extractor</title>
    <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@3.1/dist/svg.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/skeleton-tracing-js/dist/trace_skeleton.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/opentype.js/1.3.4/opentype.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; background: #222; color: #eee; }
        #toolbar { margin-bottom: 10px; }
        .svg-container { display: flex; flex-wrap: wrap; gap: 10px; }
        .svg-box { border: 1px solid #555; width: 300px; height: 300px; }
        #offscreenCanvas { display: none; }
        textarea { width: 100%; height: 200px; }
    </style>
</head>
<body>
    <h1>Font Skeleton Extractor</h1>
    <div id="toolbar">
        <label>
            Letters:
            <input id="letterInput" type="text" placeholder="Enter letters" value="ABC">
        </label>
        <button id="generateButton">Generate Skeletons</button>
        <button id="exportButton">Export JSON</button>
    </div>
    <div class="svg-container" id="svgContainer"></div>
    <textarea id="jsonOutput" readonly></textarea>
    <canvas id="offscreenCanvas" width="300" height="300"></canvas>
    
    <script>
        let font;
        const fontUrl = "./Roboto[wdth,wght].ttf";
        opentype.load(fontUrl, function(err, loadedFont) {
            if (err) { console.error("Font load error:", err); }
            else { font = loadedFont; console.log("Font loaded."); }
        });

        function createLetterOutline(letter, container) {
            const draw = SVG().addTo(container).size(300, 300);
            const glyph = font.charToGlyph(letter);
            const pathData = glyph.getPath(50, 250, 200).toPathData();
            draw.path(pathData).fill('white');
            setTimeout(() => processSkeleton(draw.node, container), 200);
        }

        function processSkeleton(svgElement, container) {
            const offscreenCanvas = document.getElementById("offscreenCanvas");
            renderSVGToCanvas(svgElement, offscreenCanvas, function() {
                const skeleton = extractSkeleton(offscreenCanvas);
                visualizeSkeleton(skeleton, container);
            });
        }

        function renderSVGToCanvas(svgElement, canvasElement, callback) {
            const svgString = svgElement.outerHTML;
            const blob = new Blob([svgString], { type: "image/svg+xml;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const img = new Image();
            img.onload = function() {
                const ctx = canvasElement.getContext("2d");
                ctx.fillStyle = "black";
                ctx.fillRect(0, 0, canvasElement.width, canvasElement.height);
                ctx.drawImage(img, 0, 0, canvasElement.width, canvasElement.height);
                URL.revokeObjectURL(url);
                callback();
            };
            img.src = url;
        }

        function extractSkeleton(canvasElement) {
            return TraceSkeleton.fromCanvas(canvasElement);
        }

        function visualizeSkeleton(skeleton, container) {
            const svgString = TraceSkeleton.visualize(skeleton, { scale: 1, strokeWidth: 2, keypoints: true });
            container.innerHTML = svgString;
        }

        function exportSkeletonData() {
            const skeletons = [];
            document.querySelectorAll('.svg-box').forEach((box, index) => {
                const letter = document.getElementById("letterInput").value[index];
                const skeleton = TraceSkeleton.fromCanvas(document.getElementById("offscreenCanvas"));
                skeletons.push({ name: letter.toLowerCase(), gestures: skeleton.polylines.map(poly => poly.map(pt => ({ X: pt[0], Y: pt[1], ID: 0 }))) });
            });
            document.getElementById("jsonOutput").value = JSON.stringify(skeletons, null, 2);
        }

        document.getElementById("generateButton").addEventListener("click", function() {
            const letters = document.getElementById("letterInput").value.toUpperCase().split("");
            const container = document.getElementById("svgContainer");
            container.innerHTML = "";
            letters.forEach(letter => {
                const box = document.createElement("div");
                box.className = "svg-box";
                container.appendChild(box);
                createLetterOutline(letter, box);
            });
        });

        document.getElementById("exportButton").addEventListener("click", exportSkeletonData);
    </script>
</body>
</html>
